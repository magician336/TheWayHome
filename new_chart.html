<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›½äº§ç‹¬ç«‹æ¸¸æˆæ•°æ®å¯è§†åŒ–åˆ†æ</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* --- åŸºç¡€å¸ƒå±€ --- */
    body {
      margin: 0; padding: 0;
      background-color: #050505;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
      min-height: 100vh;
    }

    h2 {
      text-align: center; padding: 15px 0; margin: 0;
      font-weight: 300; color: #ffd700; background: #0a0a0a;
      letter-spacing: 2px; font-size: 22px; 
    }

    /* é¡¶éƒ¨æ§åˆ¶æ  */
    .controls {
      display: flex; justify-content: center; align-items: center; gap: 20px;
      padding: 15px; background: #0a0a0a; border-bottom: 1px solid #222;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .input-group { display: flex; align-items: center; gap: 8px; }
    label { font-size: 13px; color: #888; }
    input[type="text"], select {
      background: #1a1a1a; border: 1px solid #333; color: #ffd700;
      padding: 6px 10px; border-radius: 4px; outline: none; font-size: 13px;
    }
    button {
      background: #333; color: #fff; border: none; padding: 6px 15px;
      border-radius: 4px; cursor: pointer; font-size: 13px;
    }
    button:hover { background: #555; }

    /* --- ä»ªè¡¨ç›˜ä¸»å®¹å™¨ --- */
    #dashboard {
      display: grid;
      /* å·¦å³æ¯”ä¾‹ 2.8 : 1.2 */
      grid-template-columns: minmax(0, 2.8fr) minmax(0, 1.2fr);
      grid-template-rows: auto auto;
      gap: 20px;
      width: 98%; max-width: 1800px; 
      margin: 20px auto; padding-bottom: 40px;
    }

    /* ç¬¬ä¸€è¡Œ */
    #main-chart-wrapper { grid-column: 1 / 2; grid-row: 1 / 2; height: 550px; }
    #tags-chart-wrapper { grid-column: 2 / 3; grid-row: 1 / 2; height: 550px; }

    /* ç¬¬äºŒè¡Œ */
    #bottom-row-wrapper {
      grid-column: 1 / -1; grid-row: 2 / 3;
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 20px; height: 400px;
    }

    .chart-box {
      background: #111; border-radius: 8px; border: 1px solid #222;
      padding: 15px; box-sizing: border-box;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex; flex-direction: column;
      width: 100%; height: 100%; 
      overflow: hidden; /* é˜²æ­¢å†…éƒ¨æ’‘å¤§ */
    }

    /* å“åº”å¼ */
    @media (max-width: 1200px) {
      #dashboard { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      #main-chart-wrapper { grid-column: 1 / -1; height: 500px; }
      #tags-chart-wrapper { grid-column: 1 / -1; grid-row: 2 / 3; height: 500px; }
      #bottom-row-wrapper { grid-column: 1 / -1; grid-row: 3 / 4; grid-template-columns: 1fr; height: auto; }
      .chart-box { min-height: 350px; }
    }

    .chart-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px; height: 30px; flex-shrink: 0;
    }
    .chart-title { font-size: 14px; color: #ddd; border-left: 4px solid #ffd700; padding-left: 10px; font-weight: 500;}
    
    /* ä¿®å¤ï¼šç»™ç»˜å›¾å®¹å™¨å¼ºåˆ¶åŠ ä¸Š overflow hidden */
    .viz-box { 
      flex: 1; 
      position: relative; 
      width: 100%; 
      height: 100%; 
      overflow: hidden; 
    }

    /* --- D3 SVG æ ·å¼ --- */
    .axis line, .axis path { stroke: #444; }
    .axis text { fill: #888; font-size: 11px; }
    .axis-title { fill: #aaa; font-size: 12px; font-weight: bold; cursor: default; }
    
    path.line { fill: none; transition: stroke-opacity 0.3s, stroke-width 0.3s; }
    path.line.active { stroke-opacity: 1 !important; stroke-width: 3px; }
    path.line.inactive { stroke-opacity: 0.05 !important; stroke-width: 1px; stroke: #555 !important; }
    path.line.highlight { stroke-opacity: 1 !important; stroke-width: 4px; stroke: #fff !important; z-index: 1000; }

    .dot { stroke: #000; stroke-width: 1px; transition: r 0.2s; }
    .dot:hover { stroke: #fff; stroke-width: 2px; }
    
    .bubble { cursor: pointer; transition: all 0.3s; }
    .bubble:hover { stroke: #fff; stroke-width: 2px; filter: brightness(1.2); }
    .bubble-text { font-family: sans-serif; pointer-events: none; text-anchor: middle; fill: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); font-weight: bold;}
    .bubble-subtext { font-family: sans-serif; pointer-events: none; text-anchor: middle; fill: #ccc; font-size: 10px;}
    
    .tooltip { position: absolute; background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 6px; color: #fff; padding: 12px; font-size: 12px; pointer-events: none; opacity: 0; z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.8); backdrop-filter: blur(4px); white-space: nowrap; }
    .tooltip-title { color: #ffd700; font-weight: bold; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 4px; font-size: 14px;}
    .tooltip-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 3px; }
    .tag-pill { display: inline-block; background: #333; padding: 2px 6px; border-radius: 4px; margin: 2px; font-size: 10px; color: #ccc; border: 1px solid #444;}
  </style>
</head>
<body>

  <h2>å›½äº§ç‹¬ç«‹æ¸¸æˆæ•°æ®å¯è§†åŒ–åˆ†æ</h2>
  
  <div class="controls">
    <div class="input-group">
      <label>ğŸ” æœç´¢:</label>
      <input type="text" id="searchName" placeholder="è¾“å…¥åç§° (å¦‚: æ‚Ÿç©º)">
    </div>
    <div class="input-group">
      <label>ğŸ“… å¹´ä»½:</label>
      <select id="selectYear"><option value="">å…¨éƒ¨</option></select>
    </div>
    <button onclick="resetFilters()">é‡ç½®</button>
  </div>

  <div id="dashboard">
    <div id="main-chart-wrapper" class="chart-box">
       <div id="main-chart-container" class="viz-box"></div>
    </div>
    <div id="tags-chart-wrapper" class="chart-box">
      <div class="chart-header"><span class="chart-title">Tags ç±»åˆ«ä¸çƒ­åº¦</span></div>
      <div id="tag-viz" class="viz-box"></div>
    </div>

    <div id="bottom-row-wrapper">
        <div class="chart-box">
          <div class="chart-header">
            <span class="chart-title">å±æ€§å½±å“åˆ†æ (Impact)</span>
            <select id="targetSelect" style="width: 100px; cursor: pointer;">
              <option value="favorable_rate">å¥½è¯„ç‡</option>
              <option value="log_players">åœ¨çº¿äººæ•°</option>
              <option value="retention_days">ç•™å­˜å¤©æ•°</option>
            </select>
          </div>
          <div id="bar-viz" class="viz-box"></div>
        </div>
        <div class="chart-box">
          <div class="chart-header"><span class="chart-title">ç›¸å…³æ€§çƒ­åŠ›å›¾ (Correlation)</span></div>
          <div id="heatmap-viz" class="viz-box"></div>
        </div>
        <div class="chart-box">
          <div class="chart-header">
            <span class="chart-title">å˜é‡å…³ç³»åˆ†å¸ƒ (Scatter)</span>
            <div style="display:flex; gap:5px; align-items: center;">
              <span style="font-size:12px; color:#888;">X:</span>
              <select id="scatterX" style="width: 75px;">
                <option value="year" selected>å¹´ä»½</option>
                <option value="original_price">å”®ä»·</option>
                <option value="discount_strength">æŠ˜æ‰£</option>
              </select>
              <span style="font-size:12px; color:#888;">Y:</span>
              <select id="scatterY" style="width: 75px;">
                <option value="log_players" selected>åœ¨çº¿</option>
                <option value="favorable_rate">å¥½è¯„ç‡</option>
                <option value="retention_days">ç•™å­˜</option>
              </select>
            </div>
          </div>
          <div id="scatter-viz" class="viz-box"></div>
        </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    // --- 1. æ¸¸æˆæ•°æ® (è¯·å¡«å…¥ä½ çš„å®Œæ•´ rawData) ---
    const rawData = [
  {
    "name": "The Scroll Of Taiwu",
    "year": 2018,
    "original_price": 68.0,
    "favorable_rate": 69.43,
    "total_comments": 61589,
    "max_players": 72533,
    "retention_days": 49,
    "discount_count": 20,
    "avg_discount_rate": 0.08,
    "discount_strength": 43.53,
    "main_tag": "RPG",
    "years_since_release": 7.2
  },
  {
    "name": "Chinese Parents",
    "year": 2018,
    "original_price": 36.0,
    "favorable_rate": 91.42,
    "total_comments": 26306,
    "max_players": 32593,
    "retention_days": 42,
    "discount_count": 20,
    "avg_discount_rate": 0.19,
    "discount_strength": 93.42,
    "main_tag": "Life Sim",
    "years_since_release": 8.2
  },
  {
    "name": "Gujian3(å¤å‰‘å¥‡è°­ä¸‰)",
    "year": 2018,
    "original_price": 99.0,
    "favorable_rate": 85.97,
    "total_comments": 48555,
    "max_players": 10183,
    "retention_days": 56,
    "discount_count": 5,
    "avg_discount_rate": 0.26,
    "discount_strength": 23.22,
    "main_tag": "RPG",
    "years_since_release": 7.0
  },
  {
    "name": "My Time at Portia",
    "year": 2018,
    "original_price": 98.0,
    "favorable_rate": 91.59,
    "total_comments": 43820,
    "max_players": 13299,
    "retention_days": 238,
    "discount_count": 54,
    "avg_discount_rate": 0.34,
    "discount_strength": 441.75,
    "main_tag": "Life Sim",
    "years_since_release": 8.5
  },
  {
    "name": "PixARK",
    "year": 2018,
    "original_price": 68.0,
    "favorable_rate": 72.96,
    "total_comments": 12835,
    "max_players": 14144,
    "retention_days": 56,
    "discount_count": 10,
    "avg_discount_rate": 0.25,
    "discount_strength": 42.83,
    "main_tag": "Survival",
    "years_since_release": 8.3
  },
  {
    "name": "æ­¦ä¾ ä¹‚ The Swordsmen X",
    "year": 2018,
    "original_price": 88.0,
    "favorable_rate": 47.24,
    "total_comments": 3529,
    "max_players": 5075,
    "retention_days": 77,
    "discount_count": 36,
    "avg_discount_rate": 0.28,
    "discount_strength": 276.42,
    "main_tag": "Massively Multiplayer",
    "years_since_release": 7.4
  },
  {
    "name": "Ho Tu Lo Shu ï¼š The Books of Dragon",
    "year": 2018,
    "original_price": 88.0,
    "favorable_rate": 81.83,
    "total_comments": 10819,
    "max_players": 1877,
    "retention_days": 189,
    "discount_count": 28,
    "avg_discount_rate": 0.19,
    "discount_strength": 169.26,
    "main_tag": "RPG",
    "years_since_release": 7.1
  },
  {
    "name": "Gunfire Reborn",
    "year": 2020,
    "original_price": 68.0,
    "favorable_rate": 93.27,
    "total_comments": 101753,
    "max_players": 35263,
    "retention_days": 133,
    "discount_count": 10,
    "avg_discount_rate": 0.23,
    "discount_strength": 88.25,
    "main_tag": "Roguelite",
    "years_since_release": 5.6
  },
  {
    "name": "Pascal's Wager: Definitive Edition",
    "year": 2020,
    "original_price": 80.0,
    "favorable_rate": 70.45,
    "total_comments": 1330,
    "max_players": 624,
    "retention_days": 21,
    "discount_count": 23,
    "avg_discount_rate": 0.26,
    "discount_strength": 244.06,
    "main_tag": "Souls-like",
    "years_since_release": 4.8
  },
  {
    "name": "Sands of Salzaar",
    "year": 2020,
    "original_price": 48.0,
    "favorable_rate": 81.86,
    "total_comments": 22806,
    "max_players": 21047,
    "retention_days": 35,
    "discount_count": 20,
    "avg_discount_rate": 0.23,
    "discount_strength": 172.71,
    "main_tag": "Open World",
    "years_since_release": 5.9
  },
  {
    "name": "Neon Abyss",
    "year": 2020,
    "original_price": 58.0,
    "favorable_rate": 86.05,
    "total_comments": 23389,
    "max_players": 6278,
    "retention_days": 49,
    "discount_count": 52,
    "avg_discount_rate": 0.28,
    "discount_strength": 549.5,
    "main_tag": "Roguelike",
    "years_since_release": 5.4
  },
  {
    "name": "æ¸¯è©­å¯¦éŒ„ParanormalHK",
    "year": 2020,
    "original_price": 56.0,
    "favorable_rate": 89.68,
    "total_comments": 19629,
    "max_players": 1221,
    "retention_days": 98,
    "discount_count": 43,
    "avg_discount_rate": 0.2,
    "discount_strength": 299.55,
    "main_tag": "Horror",
    "years_since_release": 5.9
  },
  {
    "name": "Biped",
    "year": 2020,
    "original_price": 58.0,
    "favorable_rate": 85.48,
    "total_comments": 10200,
    "max_players": 4961,
    "retention_days": 35,
    "discount_count": 46,
    "avg_discount_rate": 0.28,
    "discount_strength": 469.29,
    "main_tag": "Cartoony",
    "years_since_release": 5.7
  },
  {
    "name": "ä¿ ä¹‹é“(PathOfWuxia)",
    "year": 2020,
    "original_price": 98.0,
    "favorable_rate": 78.33,
    "total_comments": 30290,
    "max_players": 16175,
    "retention_days": 28,
    "discount_count": 1,
    "avg_discount_rate": 0.26,
    "discount_strength": 9.98,
    "main_tag": "RPG",
    "years_since_release": 5.6
  },
  {
    "name": "æš–é›ª Warm Snow",
    "year": 2022,
    "original_price": 58.0,
    "favorable_rate": 93.07,
    "total_comments": 38003,
    "max_players": 44702,
    "retention_days": 42,
    "discount_count": 31,
    "avg_discount_rate": 0.13,
    "discount_strength": 211.31,
    "main_tag": "Action Roguelike",
    "years_since_release": 3.9
  },
  {
    "name": "My Time at Sandrock",
    "year": 2022,
    "original_price": 98.0,
    "favorable_rate": 88.14,
    "total_comments": 27664,
    "max_players": 21778,
    "retention_days": 28,
    "discount_count": 22,
    "avg_discount_rate": 0.22,
    "discount_strength": 245.57,
    "main_tag": "Life Sim",
    "years_since_release": 3.6
  },
  {
    "name": "Richman 11",
    "year": 2022,
    "original_price": 66.0,
    "favorable_rate": 47.22,
    "total_comments": 2700,
    "max_players": 3258,
    "retention_days": 238,
    "discount_count": 23,
    "avg_discount_rate": 0.19,
    "discount_strength": 250.48,
    "main_tag": "Indie",
    "years_since_release": 3.2
  },
  {
    "name": "ã€Šæ–‡å­—éŠæˆ²ã€‹",
    "year": 2022,
    "original_price": 48.0,
    "favorable_rate": 93.87,
    "total_comments": 6138,
    "max_players": 4105,
    "retention_days": 21,
    "discount_count": 25,
    "avg_discount_rate": 0.1,
    "discount_strength": 123.12,
    "main_tag": "Exploration",
    "years_since_release": 3.9
  },
  {
    "name": "ANNO:Mutationem",
    "year": 2022,
    "original_price": 78.0,
    "favorable_rate": 80.86,
    "total_comments": 6302,
    "max_players": 2938,
    "retention_days": 14,
    "discount_count": 32,
    "avg_discount_rate": 0.2,
    "discount_strength": 334.83,
    "main_tag": "RPG",
    "years_since_release": 3.7
  },
  {
    "name": "å¥‡æ€ªçš„RPG",
    "year": 2022,
    "original_price": 38.0,
    "favorable_rate": 92.43,
    "total_comments": 4095,
    "max_players": 1160,
    "retention_days": 98,
    "discount_count": 20,
    "avg_discount_rate": 0.19,
    "discount_strength": 265.13,
    "main_tag": "RPG",
    "years_since_release": 3.2
  },
  {
    "name": "å¤ªè’åˆå¢ƒ",
    "year": 2022,
    "original_price": 68.0,
    "favorable_rate": 37.55,
    "total_comments": 13638,
    "max_players": 36315,
    "retention_days": 35,
    "discount_count": 13,
    "avg_discount_rate": 0.32,
    "discount_strength": 218.06,
    "main_tag": "Sandbox",
    "years_since_release": 3.7
  },
  {
    "name": "Black Myth: Wukong",
    "year": 2024,
    "original_price": 268.0,
    "favorable_rate": 96.59,
    "total_comments": 1186287,
    "max_players": 2415714,
    "retention_days": 42,
    "discount_count": 3,
    "avg_discount_rate": 0.08,
    "discount_strength": 26.32,
    "main_tag": "Mythology",
    "years_since_release": 1.5
  },
  {
    "name": "The Hungry Lamb: Traveling in the Late Ming Dynasty",
    "year": 2024,
    "original_price": 37.0,
    "favorable_rate": 94.93,
    "total_comments": 56660,
    "max_players": 5093,
    "retention_days": 161,
    "discount_count": 12,
    "avg_discount_rate": 0.12,
    "discount_strength": 177.46,
    "main_tag": "Visual Novel",
    "years_since_release": 1.6
  },
  {
    "name": "Soulmask",
    "year": 2024,
    "original_price": 108.0,
    "favorable_rate": 80.63,
    "total_comments": 16775,
    "max_players": 46833,
    "retention_days": 84,
    "discount_count": 15,
    "avg_discount_rate": 0.13,
    "discount_strength": 228.36,
    "main_tag": "Survival",
    "years_since_release": 1.5
  },
  {
    "name": "Murders on the Yangtze River",
    "year": 2024,
    "original_price": 58.0,
    "favorable_rate": 97.21,
    "total_comments": 19715,
    "max_players": 4964,
    "retention_days": 105,
    "discount_count": 16,
    "avg_discount_rate": 0.13,
    "discount_strength": 224.28,
    "main_tag": "Detective",
    "years_since_release": 1.9
  },
  {
    "name": "ä¸­å›½å¼ç½‘æ¸¸",
    "year": 2024,
    "original_price": 32.0,
    "favorable_rate": 86.0,
    "total_comments": 10167,
    "max_players": 12301,
    "retention_days": 21,
    "discount_count": 11,
    "avg_discount_rate": 0.1,
    "discount_strength": 156.33,
    "main_tag": "CRPG",
    "years_since_release": 1.4
  },
  {
    "name": "Feed The Cups",
    "year": 2024,
    "original_price": 58.0,
    "favorable_rate": 31.68,
    "total_comments": 13929,
    "max_players": 11413,
    "retention_days": 620,
    "discount_count": 9,
    "avg_discount_rate": 0.06,
    "discount_strength": 66.11,
    "main_tag": "Cute",
    "years_since_release": 1.8
  },
  {
    "name": "Lost Castle 2",
    "year": 2024,
    "original_price": 53.0,
    "favorable_rate": 79.74,
    "total_comments": 10033,
    "max_players": 20280,
    "retention_days": 42,
    "discount_count": 11,
    "avg_discount_rate": 0.05,
    "discount_strength": 86.28,
    "main_tag": "Multiplayer",
    "years_since_release": 1.4
  },
  {
    "name": "è‰¾å¸Œ (ICEY)",
    "year": 2017,
    "original_price": 38.0,
    "favorable_rate": 88.07,
    "total_comments": 27362,
    "max_players": 3173,
    "retention_days": 14,
    "discount_count": 12,
    "avg_discount_rate": 0.22,
    "discount_strength": 55.75,
    "main_tag": "Action",
    "years_since_release": 9.1
  },
  {
    "name": "å¤±è½åŸå ¡ (Lost Castle)",
    "year": 2017,
    "original_price": 33.0,
    "favorable_rate": 84.96,
    "total_comments": 23687,
    "max_players": 4652,
    "retention_days": 1295,
    "discount_count": 24,
    "avg_discount_rate": 0.27,
    "discount_strength": 121.89,
    "main_tag": "Action",
    "years_since_release": 9.9
  },
  {
    "name": "å¤å‰‘å¥‡è°­äºŒ (GuJian2)",
    "year": 2017,
    "original_price": 49.0,
    "favorable_rate": 74.88,
    "total_comments": 2941,
    "max_players": 563,
    "retention_days": 168,
    "discount_count": 13,
    "avg_discount_rate": 0.31,
    "discount_strength": 98.49,
    "main_tag": "RPG",
    "years_since_release": 8.4
  },
  {
    "name": "ä¸‰è‰²ç»˜æ‹ (Tricolour Lovestory)",
    "year": 2017,
    "original_price": 11.0,
    "favorable_rate": 80.1,
    "total_comments": 27995,
    "max_players": 2733,
    "retention_days": 112,
    "discount_count": 76,
    "avg_discount_rate": 0.33,
    "discount_strength": 601.81,
    "main_tag": "Visual Novel",
    "years_since_release": 8.3
  },
  {
    "name": "å¤å‰‘å¥‡è°­ (GuJian)",
    "year": 2017,
    "original_price": 39.0,
    "favorable_rate": 77.8,
    "total_comments": 5555,
    "max_players": 1782,
    "retention_days": 49,
    "discount_count": 16,
    "avg_discount_rate": 0.33,
    "discount_strength": 126.52,
    "main_tag": "RPG",
    "years_since_release": 8.3
  },
  {
    "name": "è¿”æ ¡ (Detention)",
    "year": 2017,
    "original_price": 38.0,
    "favorable_rate": 80.42,
    "total_comments": 14624,
    "max_players": 2287,
    "retention_days": 28,
    "discount_count": 13,
    "avg_discount_rate": 0.27,
    "discount_strength": 61.46,
    "main_tag": "Horror",
    "years_since_release": 9.1
  },
  {
    "name": "é»‘æš—ä¸å…‰æ˜ (Dark and Light)",
    "year": 2017,
    "original_price": 52.0,
    "favorable_rate": 52.11,
    "total_comments": 11778,
    "max_players": 14089,
    "retention_days": 105,
    "discount_count": 25,
    "avg_discount_rate": 0.46,
    "discount_strength": 143.32,
    "main_tag": "Open World",
    "years_since_release": 9.0
  },
  {
    "name": "éšå½¢å®ˆæŠ¤è€…",
    "year": 2019,
    "original_price": 28.0,
    "favorable_rate": 85.46,
    "total_comments": 51655,
    "max_players": 82345,
    "retention_days": 14,
    "discount_count": 23,
    "avg_discount_rate": 0.22,
    "discount_strength": 147.65,
    "main_tag": "RPG",
    "years_since_release": 6.9
  },
  {
    "name": "æ¢çµç¬”è®°",
    "year": 2019,
    "original_price": 26.0,
    "favorable_rate": 75.89,
    "total_comments": 20404,
    "max_players": 2968,
    "retention_days": 847,
    "discount_count": 27,
    "avg_discount_rate": 0.2,
    "discount_strength": 150.2,
    "main_tag": "Horror",
    "years_since_release": 6.9
  },
  {
    "name": "äº†ä¸èµ·çš„ä¿®ä»™æ¨¡æ‹Ÿå™¨",
    "year": 2019,
    "original_price": 88.0,
    "favorable_rate": 83.95,
    "total_comments": 23431,
    "max_players": 18349,
    "retention_days": 49,
    "discount_count": 19,
    "avg_discount_rate": 0.15,
    "discount_strength": 87.97,
    "main_tag": "Simulation",
    "years_since_release": 6.9
  },
  {
    "name": "ç–‘æ¡ˆè¿½å£°",
    "year": 2019,
    "original_price": 38.0,
    "favorable_rate": 94.13,
    "total_comments": 32238,
    "max_players": 7754,
    "retention_days": 14,
    "discount_count": 56,
    "avg_discount_rate": 0.25,
    "discount_strength": 436.94,
    "main_tag": "Detective",
    "years_since_release": 6.7
  },
  {
    "name": "å…‰æ˜è®°å¿†",
    "year": 2019,
    "original_price": 29.0,
    "favorable_rate": 88.5,
    "total_comments": 39283,
    "max_players": 1907,
    "retention_days": 21,
    "discount_count": 18,
    "avg_discount_rate": 0.2,
    "discount_strength": 134.07,
    "main_tag": "Female Protagonist",
    "years_since_release": 6.9
  },
  {
    "name": "å—œè¡€å°",
    "year": 2019,
    "original_price": 79.0,
    "favorable_rate": 87.88,
    "total_comments": 38087,
    "max_players": 7267,
    "retention_days": 21,
    "discount_count": 21,
    "avg_discount_rate": 0.39,
    "discount_strength": 230.48,
    "main_tag": "Nudity",
    "years_since_release": 6.9
  },
  {
    "name": "ç¡¬æ ¸æœºç”²",
    "year": 2019,
    "original_price": 80.0,
    "favorable_rate": 79.97,
    "total_comments": 2649,
    "max_players": 1770,
    "retention_days": 21,
    "discount_count": 44,
    "avg_discount_rate": 0.25,
    "discount_strength": 278.5,
    "main_tag": "Action",
    "years_since_release": 8.1
  },
  {
    "name": "æ°¸åŠ«æ— é—´ (NARAKA: BLADEPOINT)",
    "year": 2021,
    "original_price": 0.0,
    "favorable_rate": 68.81,
    "total_comments": 336077,
    "max_players": 385770,
    "retention_days": 495,
    "discount_count": 0,
    "avg_discount_rate": 0.0,
    "discount_strength": 0.0,
    "main_tag": "Battle Royale",
    "years_since_release": 4.5
  },
  {
    "name": "é¬¼è°·å…«è’ (Tale of Immortal)",
    "year": 2021,
    "original_price": 68.0,
    "favorable_rate": 54.05,
    "total_comments": 226599,
    "max_players": 184171,
    "retention_days": 84,
    "discount_count": 16,
    "avg_discount_rate": 0.12,
    "discount_strength": 81.94,
    "main_tag": "Management",
    "years_since_release": 4.9
  },
  {
    "name": "æˆ´æ£®çƒè®¡åˆ’ (Dyson Sphere Program)",
    "year": 2021,
    "original_price": 70.0,
    "favorable_rate": 96.03,
    "total_comments": 88259,
    "max_players": 59815,
    "retention_days": 217,
    "discount_count": 31,
    "avg_discount_rate": 0.09,
    "discount_strength": 112.29,
    "main_tag": "Automation",
    "years_since_release": 4.9
  },
  {
    "name": "é£æ¥ä¹‹å›½ (Eastward)",
    "year": 2021,
    "original_price": 80.0,
    "favorable_rate": 82.16,
    "total_comments": 16202,
    "max_players": 13882,
    "retention_days": 21,
    "discount_count": 24,
    "avg_discount_rate": 0.22,
    "discount_strength": 249.12,
    "main_tag": "Pixel Graphics",
    "years_since_release": 4.3
  },
  {
    "name": "å¤ç½‘æµ·å¤–ç‰ˆ (Swords of Legends Online)",
    "year": 2021,
    "original_price": 0.0,
    "favorable_rate": 65.4,
    "total_comments": 5819,
    "max_players": 18806,
    "retention_days": 77,
    "discount_count": 0,
    "avg_discount_rate": 0.0,
    "discount_strength": 0.0,
    "main_tag": "Free to Play",
    "years_since_release": 4.7
  },
  {
    "name": "ç¬¼ä¸­çª¥æ¢¦ (Moncage)",
    "year": 2021,
    "original_price": 48.0,
    "favorable_rate": 89.3,
    "total_comments": 5436,
    "max_players": 1965,
    "retention_days": 21,
    "discount_count": 27,
    "avg_discount_rate": 0.14,
    "discount_strength": 186.3,
    "main_tag": "Puzzle",
    "years_since_release": 4.1
  },
  {
    "name": "ä»™å‰‘å¥‡ä¾ ä¼ ä¸ƒ (Sword and Fairy 7)",
    "year": 2021,
    "original_price": 128.0,
    "favorable_rate": 71.14,
    "total_comments": 18800,
    "max_players": 15245,
    "retention_days": 35,
    "discount_count": 41,
    "avg_discount_rate": 0.22,
    "discount_strength": 400.45,
    "main_tag": "RPG",
    "years_since_release": 4.1
  },
  {
    "name": "çŒ›å…½æ´¾å¯¹ (Party Animals)",
    "year": 2023,
    "original_price": 98.0,
    "favorable_rate": 78.55,
    "total_comments": 73171,
    "max_players": 104174,
    "retention_days": 49,
    "discount_count": 7,
    "avg_discount_rate": 0.19,
    "discount_strength": 95.09,
    "main_tag": "Multiplayer",
    "years_since_release": 2.3
  },
  {
    "name": "å®Œè›‹ï¼æˆ‘è¢«ç¾å¥³åŒ…å›´äº†ï¼ (Love Is All Around)",
    "year": 2023,
    "original_price": 42.0,
    "favorable_rate": 91.63,
    "total_comments": 45787,
    "max_players": 65435,
    "retention_days": 35,
    "discount_count": 17,
    "avg_discount_rate": 0.11,
    "discount_strength": 180.54,
    "main_tag": "Dating Sim",
    "years_since_release": 2.2
  },
  {
    "name": "ç«å±±çš„å¥³å„¿ (Volcano Princess)",
    "year": 2023,
    "original_price": 35.0,
    "favorable_rate": 95.93,
    "total_comments": 45796,
    "max_players": 31057,
    "retention_days": 35,
    "discount_count": 24,
    "avg_discount_rate": 0.13,
    "discount_strength": 199.4,
    "main_tag": "Life Sim",
    "years_since_release": 2.7
  },
  {
    "name": "å¤§ä¾ ç«‹å¿—ä¼ ï¼šç¢§è¡€ä¸¹å¿ƒ (Hero's Adventure: Road to Passion)",
    "year": 2023,
    "original_price": 69.0,
    "favorable_rate": 82.85,
    "total_comments": 23586,
    "max_players": 28936,
    "retention_days": 42,
    "discount_count": 21,
    "avg_discount_rate": 0.15,
    "discount_strength": 227.52,
    "main_tag": "RPG",
    "years_since_release": 2.8
  },
  {
    "name": "æ— äººç”Ÿè¿˜ (No One Survived)",
    "year": 2023,
    "original_price": 68.0,
    "favorable_rate": 64.53,
    "total_comments": 7359,
    "max_players": 4632,
    "retention_days": 126,
    "discount_count": 13,
    "avg_discount_rate": 0.2,
    "discount_strength": 183.65,
    "main_tag": "Survival",
    "years_since_release": 2.9
  },
  {
    "name": "é€¸å‰‘é£äº‘å†³ (Wandering Sword)",
    "year": 2023,
    "original_price": 78.0,
    "favorable_rate": 93.06,
    "total_comments": 38409,
    "max_players": 22824,
    "retention_days": 63,
    "discount_count": 21,
    "avg_discount_rate": 0.08,
    "discount_strength": 143.52,
    "main_tag": "RPG",
    "years_since_release": 2.3
  },
  {
    "name": "é£è¶Š13å·æˆ¿ (Breakout 13)",
    "year": 2023,
    "original_price": 32.0,
    "favorable_rate": 85.36,
    "total_comments": 7326,
    "max_players": 11996,
    "retention_days": 14,
    "discount_count": 15,
    "avg_discount_rate": 0.16,
    "discount_strength": 169.5,
    "main_tag": "FMV",
    "years_since_release": 2.9
  }
];
    
    // --- 2. Tag æ•°æ® (è¯·å¡«å…¥ tag_heat_clusters.json) ---
    const tagData = {
  "name": "root",
  "children": [
    {
      "name": "è§’è‰²æ‰®æ¼”",
      "value": 1975.17,
      "game_count": 46,
      "detail_tags": [
        "RPG",
        "Action RPG",
        "Character Customization",
        "Turn-Based",
        "JRPG",
        "CRPG",
        "Loot",
        "Turn-Based Combat"
      ]
    },
    {
      "name": "åŠ¨ä½œæ ¼æ–—",
      "value": 1651.17,
      "game_count": 41,
      "detail_tags": [
        "Action",
        "Martial Arts",
        "Action-Adventure",
        "Hack and Slash",
        "Violent",
        "Gore",
        "Combat",
        "Fighting"
      ]
    },
    {
      "name": "å‰§æƒ…å™äº‹",
      "value": 1427.55,
      "game_count": 34,
      "detail_tags": [
        "Story Rich",
        "Drama",
        "Dating Sim",
        "Multiple Endings",
        "Visual Novel",
        "Choices Matter",
        "Choose Your Own Adventure",
        "Romance"
      ]
    },
    {
      "name": "ç”Ÿå­˜å¼€æ”¾",
      "value": 1324.88,
      "game_count": 32,
      "detail_tags": [
        "Open World",
        "Sandbox",
        "Survival",
        "Exploration",
        "Crafting",
        "Open World Survival Craft",
        "Immersive Sim",
        "Mining"
      ]
    },
    {
      "name": "ä¼‘é—²æ²»æ„ˆ",
      "value": 1311.47,
      "game_count": 30,
      "detail_tags": [
        "Casual",
        "Atmospheric",
        "Funny",
        "Cute",
        "Relaxing",
        "Cartoony",
        "Family Friendly",
        "Memes"
      ]
    },
    {
      "name": "å°„å‡»å¼¹å¹•",
      "value": 1014.78,
      "game_count": 24,
      "detail_tags": [
        "Third Person",
        "FPS",
        "Shooter",
        "Top-Down",
        "Looter Shooter",
        "Bullet Hell",
        "3D Vision"
      ]
    },
    {
      "name": "æ¨¡æ‹Ÿå»ºé€ ",
      "value": 982.91,
      "game_count": 23,
      "detail_tags": [
        "Simulation",
        "Building",
        "Life Sim",
        "Base Building",
        "Management",
        "Farming Sim",
        "Time Management",
        "Cooking"
      ]
    },
    {
      "name": "å¤šäººç«æŠ€",
      "value": 976.49,
      "game_count": 24,
      "detail_tags": [
        "Multiplayer",
        "Online Co-Op",
        "Co-op",
        "Massively Multiplayer",
        "PvP",
        "Local Co-Op",
        "Local Multiplayer",
        "Battle Royale"
      ]
    },
    {
      "name": "å¥‡å¹»ç¥è¯",
      "value": 825.53,
      "game_count": 19,
      "detail_tags": [
        "Fantasy",
        "Mythology",
        "Magic",
        "Historical",
        "Medieval",
        "Dragons"
      ]
    },
    {
      "name": "è‚‰é¸½æŒ‘æˆ˜",
      "value": 725.13,
      "game_count": 17,
      "detail_tags": [
        "Roguelite",
        "Roguelike",
        "Action Roguelike",
        "Souls-like",
        "Dungeon Crawler",
        "Replay Value",
        "Difficult",
        "Procedural Generation"
      ]
    },
    {
      "name": "ç­–ç•¥æˆ˜æ£‹",
      "value": 690.37,
      "game_count": 16,
      "detail_tags": [
        "Strategy",
        "RTS",
        "Turn-Based Strategy",
        "War",
        "Real Time Tactics",
        "Tower Defense",
        "Military",
        "Tactical"
      ]
    },
    {
      "name": "ææ€–æ‚¬ç–‘",
      "value": 596.64,
      "game_count": 14,
      "detail_tags": [
        "Psychological Horror",
        "Horror",
        "Survival Horror",
        "Dark",
        "Dark Fantasy",
        "Thriller",
        "Lovecraftian",
        "Zombies"
      ]
    },
    {
      "name": "å¹³å°é“¶æ²³åŸ",
      "value": 458.11,
      "game_count": 11,
      "detail_tags": [
        "Platformer",
        "2D Platformer",
        "2.5D",
        "3D Platformer",
        "Side Scroller",
        "Metroidvania",
        "Parkour"
      ]
    },
    {
      "name": "è§£è°œæ¢æ¡ˆ",
      "value": 403.75,
      "game_count": 10,
      "detail_tags": [
        "Puzzle",
        "Puzzle Platformer",
        "Mystery",
        "Detective",
        "Point & Click",
        "Logic",
        "Investigation"
      ]
    },
    {
      "name": "ç§‘å¹»æœºç”²",
      "value": 400.84,
      "game_count": 10,
      "detail_tags": [
        "Sci-fi",
        "Post-apocalyptic",
        "Cyberpunk",
        "Futuristic",
        "Mechs",
        "Space",
        "Space Sim"
      ]
    },
    {
      "name": "å¡ç‰Œæ„å»º",
      "value": 54.69,
      "game_count": 1,
      "detail_tags": [
        "Deckbuilding"
      ]
    }
  ]
};

    const currentYear = 2025;
    let data = [];
    if (rawData && rawData.length > 0) {
        data = rawData.map(d => ({
          ...d,
          log_players: Math.log10(d.max_players < 1 ? 1 : d.max_players),
          discount_strength: (d.discount_count * (d.avg_discount_rate * 100)) / Math.max(0.1, currentYear - d.year)
        }));
    }

    const nameMap = { "year": "å¹´ä»½", "original_price": "å”®ä»· (Â¥)", "discount_strength": "æŠ˜æ‰£åŠ›åº¦", "favorable_rate": "å¥½è¯„ç‡ (%)", "log_players": "åœ¨çº¿äººæ•° (10^x)", "retention_days": "ç•™å­˜å¤©æ•° (Days)" };

    const yearSelect = document.getElementById('selectYear');
    if(data.length > 0){
        const years = [...new Set(data.map(d => d.year))].sort((a, b) => b - a);
        years.forEach(year => {
          const opt = document.createElement('option'); opt.value = year; opt.innerText = year; yearSelect.appendChild(opt);
        });
    }

    function showTooltip(event, content) {
        const tooltip = d3.select("#tooltip");
        tooltip.html(content).style("opacity", 1);
        const tooltipNode = tooltip.node();
        const tipWidth = tooltipNode.offsetWidth; const tipHeight = tooltipNode.offsetHeight;
        const windowWidth = window.innerWidth; const windowHeight = window.innerHeight;
        let left = event.pageX + 15; let top = event.pageY + 15;
        if (left + tipWidth > windowWidth) left = event.pageX - tipWidth - 15;
        if (event.clientY + tipHeight + 20 > windowHeight) top = event.pageY - tipHeight - 15;
        tooltip.style("left", left + "px").style("top", top + "px");
    }

    // --- ä¸»å›¾ ---
    function drawParallelPlot() {
      if(data.length === 0) return;
      const dimensions = [
        { key: "year", name: "å¹´ä»½" },
        { key: "original_price", name: "å”®ä»·" },
        { key: "discount_strength", name: "æŠ˜æ‰£åŠ›åº¦" },
        { key: "favorable_rate", name: "å¥½è¯„ç‡" },
        { key: "log_players", name: "åœ¨çº¿(10^x)" },
        { key: "retention_days", name: "ç•™å­˜" }
      ];

      const container = document.getElementById('main-chart-container');
      const width = container.clientWidth - 120;
      const height = container.clientHeight - 60; 
      const margin = { top: 40, right: 60, bottom: 20, left: 60 };

      // ä½¿ç”¨ innerHTML å½»åº•æ¸…ç©ºï¼Œé˜²æ­¢å †å 
      container.innerHTML = "";

      const svg = d3.select("#main-chart-container").append("svg")
        .attr("width", container.clientWidth)
        .attr("height", container.clientHeight)
        .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scalePoint().range([0, width]).padding(0).domain(dimensions.map(d => d.key));
      const y = {};
      dimensions.forEach(dim => {
        if (dim.key === 'log_players') y[dim.key] = d3.scaleLinear().domain([2, 7]).range([height, 0]);
        else if (dim.key === 'favorable_rate') y[dim.key] = d3.scaleLinear().domain([30, 100]).range([height, 0]);
        else y[dim.key] = d3.scaleLinear().domain(d3.extent(data, d => d[dim.key])).range([height, 0]);
      });

      const colorScale = d3.scaleSequential().domain([100, 40]).interpolator(d3.interpolateTurbo);
      const line = d3.line().defined(d => !isNaN(d[1])).x(d => x(d[0])).y(d => y[d[0]](d[1]));

      const pathGroup = svg.append("g");
      const paths = pathGroup.selectAll("path")
        .data(data).enter().append("path")
        .attr("class", "line") 
        .attr("d", d => line(dimensions.map(p => [p.key, d[p.key]])))
        .style("stroke", d => colorScale(d.favorable_rate))
        .style("stroke-opacity", 0.6)
        .style("stroke-width", 1.5);

      svg.selectAll("myAxis").data(dimensions).enter().append("g")
        .attr("class", "axis").attr("transform", d => `translate(${x(d.key)})`)
        .each(function(d) { 
          const axis = d3.axisLeft(y[d.key]);
          if(d.key === 'year') axis.tickFormat(d3.format("d"));
          d3.select(this).call(axis); 
        })
        .append("text").style("text-anchor", "middle").attr("y", -15).attr("class", "axis-title").text(d => d.name);
      
      window.updateParallelChart = function(searchVal, yearVal) {
        const isFiltered = (searchVal !== "") || (yearVal !== "");
        paths.each(function(d) {
          const match = (!searchVal || d.name.toLowerCase().includes(searchVal.toLowerCase())) &&
                        (!yearVal || d.year == yearVal);
          const el = d3.select(this);
          el.classed("highlight", false); 
          if (!isFiltered) {
            el.classed("active", false).classed("inactive", false)
              .style("stroke-opacity", 0.6).style("stroke-width", 1.5).style("stroke", colorScale(d.favorable_rate));
          } else {
            if (match) {
              el.classed("active", true).classed("inactive", false)
                .style("stroke-opacity", 1).style("stroke-width", 3).style("stroke", colorScale(d.favorable_rate));
              el.raise();
            } else {
              el.classed("active", false).classed("inactive", true)
                .style("stroke-opacity", 0.05).style("stroke-width", 1).style("stroke", "#555");
            }
          }
        });
      };
      
      paths.on("mouseover", function(event, d) {
        if(d3.select(this).classed("inactive")) return;
        d3.select(this).classed("highlight", true).raise();
        const content = `
          <div class="tooltip-title">${d.name}</div>
          <div class="tooltip-row"><span>å¹´ä»½:</span> <b>${d.year}</b></div>
          <div class="tooltip-row"><span>å¥½è¯„ç‡:</span> <b>${d.favorable_rate}%</b></div>
          <div class="tooltip-row"><span>å”®ä»·:</span> <b>Â¥${d.original_price}</b></div>
          <div class="tooltip-row"><span>åœ¨çº¿äººæ•°:</span> <b>${d.max_players}</b></div>
        `;
        showTooltip(event, content);
      })
      .on("mouseout", function() {
        const sVal = document.getElementById('searchName').value;
        const yVal = document.getElementById('selectYear').value;
        window.updateParallelChart(sVal, yVal);
        d3.select("#tooltip").style("opacity", 0);
      });
    }

    // --- Tagså›¾ ---
    function drawTagBubbleChart() {
      if (!tagData) return;
      const container = document.getElementById('tag-viz');
      container.innerHTML = ""; // å½»åº•æ¸…ç©º

      const width = container.clientWidth; const height = container.clientHeight;
      const svg = d3.select("#tag-viz").append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).style("display", "block").style("margin", "0 auto");
      
      const root = d3.hierarchy(tagData).sum(d => Math.pow(d.value, 0.6)).sort((a, b) => b.value - a.value);
      const pack = d3.pack().size([width, height]).padding(3);
      pack(root);
      const color = d3.scaleSequential([0, root.children.length], d3.interpolateMagma);
      const nodes = svg.selectAll("g").data(root.leaves()).join("g").attr("transform", d => `translate(${d.x},${d.y})`).attr("class", "node-group");
      
      nodes.append("circle").attr("r", d => d.r).attr("class", "bubble").style("fill", (d, i) => color(i)).style("fill-opacity", 0.8).style("stroke", "#000").style("stroke-width", 1);
      
      nodes.append("text").attr("class", "bubble-text main-label").attr("y", -2).text(d => d.data.name)
          .style("font-size", d => Math.max(8, Math.min(d.r / 2.2, 16)) + "px").style("opacity", d => d.r > 10 ? 1 : 0)
          .style("pointer-events", "none").style("text-anchor", "middle").style("fill", "#fff").style("text-shadow", "0 1px 2px rgba(0,0,0,0.8)").style("font-weight", "bold");
      
      nodes.append("text").attr("class", "bubble-subtext sub-label").attr("y", d => d.r / 2.2 + 4).text(d => Math.round(d.data.value))
          .style("font-size", d => Math.max(7, Math.min(d.r / 3, 10)) + "px").style("opacity", d => d.r > 12 ? 0.8 : 0)
          .style("pointer-events", "none").style("text-anchor", "middle").style("fill", "#ddd");

      nodes.on("mouseover", function(event, d) {
          const group = d3.select(this);
          group.raise(); 
          group.select("circle").transition().duration(200).attr("r", d.r * 1.3).style("stroke", "#fff").style("stroke-width", 2).style("fill-opacity", 1);
          group.selectAll("text").transition().duration(200).style("opacity", 1).style("font-size", function() { return d3.select(this).classed("main-label") ? "14px" : "10px"; });
          let tagsHtml = "";
          if(d.data.detail_tags) tagsHtml = d.data.detail_tags.map(t => `<span class="tag-pill">${t}</span>`).join("");
          const content = `<div class="tooltip-title">${d.data.name}</div><div class="tooltip-row"><span>ç»¼åˆçƒ­åº¦:</span> <b>${Math.round(d.data.value)}</b></div><div class="tooltip-row"><span>å…³è”æ¸¸æˆæ•°:</span> <b>${d.data.game_count}</b></div><div style="margin-top:8px; border-top:1px solid #333; paddingTop:4px;"><div style="color:#aaa; font-size:10px;">åŒ…å« Tags:</div><div style="white-space:normal; max-width:200px;">${tagsHtml}</div></div>`;
          showTooltip(event, content);
      }).on("mouseout", function(event, d) {
          const group = d3.select(this);
          group.select("circle").transition().duration(200).attr("r", d.r).style("stroke", "#000").style("stroke-width", 1).style("fill-opacity", 0.8);
          group.select(".main-label").transition().duration(200).style("font-size", Math.max(8, Math.min(d.r / 2.2, 16)) + "px").style("opacity", d.r > 10 ? 1 : 0);
          group.select(".sub-label").transition().duration(200).style("font-size", Math.max(7, Math.min(d.r / 3, 10)) + "px").style("opacity", d.r > 12 ? 0.8 : 0);
          d3.select("#tooltip").style("opacity", 0);
      });
    }

    function calculateCorrelation(xArray, yArray) {
      const n = xArray.length; if (n <= 1) return 0;
      const sumX = d3.sum(xArray), sumY = d3.sum(yArray);
      const meanX = sumX / n, meanY = sumY / n;
      let numerator = 0, denominatorX = 0, denominatorY = 0;
      for (let i = 0; i < n; i++) { const dx = xArray[i] - meanX, dy = yArray[i] - meanY; numerator += dx * dy; denominatorX += dx * dx; denominatorY += dy * dy; }
      const denominator = Math.sqrt(denominatorX * denominatorY); return denominator === 0 ? 0 : numerator / denominator;
    }

    // --- é™„å›¾ 1: æ¡å½¢å›¾ (å…³é”®ä¿®å¤ï¼šå½»åº•æ¸…ç©º) ---
    function drawBarChart(targetKey) {
      if(data.length === 0) return;
      
      const container = document.getElementById('bar-viz');
      container.innerHTML = ""; // å…³é”®ä¿®å¤ï¼šå½»åº•æ¸…ç©ºå®¹å™¨å†…å®¹ï¼Œé˜²æ­¢SVGå †å 

      const features = [{key: 'year', name: 'å¹´ä»½'}, {key: 'original_price', name: 'å”®ä»·'}, {key: 'discount_strength', name: 'æŠ˜æ‰£'}];
      const chartData = features.map(f => ({ feature: f.name, value: calculateCorrelation(data.map(d => d[f.key]), data.map(d => d[targetKey])) }));
      
      const width = container.clientWidth; 
      const height = container.clientHeight;
      const margin = { top: 20, right: 30, bottom: 30, left: 50 };
      
      const svg = d3.select("#bar-viz").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const innerW = width - margin.left - margin.right; const innerH = height - margin.top - margin.bottom;
      
      const x = d3.scaleLinear().domain([-1, 1]).range([0, innerW]);
      const y = d3.scaleBand().range([0, innerH]).domain(chartData.map(d => d.feature)).padding(0.4);
      svg.append("line").attr("x1", x(0)).attr("x2", x(0)).attr("y1", 0).attr("y2", innerH).attr("stroke", "#555").attr("stroke-dasharray", "4");
      svg.selectAll("rect").data(chartData).enter().append("rect").attr("x", d => x(Math.min(0, d.value))).attr("y", d => y(d.feature)).attr("width", d => Math.abs(x(d.value) - x(0))).attr("height", y.bandwidth()).attr("fill", d => d.value > 0 ? "#ff4d4d" : "#00d4ff").attr("rx", 4);
      svg.append("g").call(d3.axisLeft(y).tickSize(0)).select(".domain").remove();
      svg.append("g").attr("transform", `translate(0,${innerH})`).call(d3.axisBottom(x).ticks(5));
      svg.selectAll(".val-label").data(chartData).enter().append("text").attr("x", d => d.value > 0 ? x(d.value) + 5 : x(d.value) - 5).attr("y", d => y(d.feature) + y.bandwidth()/2 + 4).attr("text-anchor", d => d.value > 0 ? "start" : "end").text(d => d.value.toFixed(2)).style("fill", "#fff").style("font-size", "11px");
    }

    // --- é™„å›¾ 2: çƒ­åŠ›å›¾ ---
    function drawHeatmap() {
      if(data.length === 0) return;
      const container = document.getElementById('heatmap-viz');
      container.innerHTML = ""; // å½»åº•æ¸…ç©º

      const features = ['year', 'original_price', 'discount_strength', 'favorable_rate', 'log_players', 'retention_days'];
      const labels = ['å¹´ä»½', 'å”®ä»·', 'æŠ˜æ‰£', 'å¥½è¯„', 'åœ¨çº¿', 'ç•™å­˜'];
      const heatmapData = []; features.forEach((rowFeat, i) => { features.forEach((colFeat, j) => { heatmapData.push({ x: j, y: i, value: calculateCorrelation(data.map(d=>d[rowFeat]), data.map(d=>d[colFeat])) }); }); });
      
      const width = container.clientWidth; const height = container.clientHeight;
      const margin = { top: 20, right: 10, bottom: 40, left: 40 };
      
      const svg = d3.select("#heatmap-viz").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const innerW = width - margin.left - margin.right; const innerH = height - margin.top - margin.bottom;
      const x = d3.scaleBand().range([0, innerW]).domain(d3.range(features.length)).padding(0.05);
      const y = d3.scaleBand().range([0, innerH]).domain(d3.range(features.length)).padding(0.05);
      const color = d3.scaleLinear().domain([-1, 0, 1]).range(["#00d4ff", "#1a1a1a", "#ff4d4d"]);
      svg.selectAll().data(heatmapData).enter().append("rect").attr("x", d => x(d.x)).attr("y", d => y(d.y)).attr("width", x.bandwidth()).attr("height", y.bandwidth()).style("fill", d => color(d.value))
        .on("mouseover", function(event, d) { d3.select(this).style("stroke", "#fff").style("stroke-width", 2); showTooltip(event, `${labels[d.x]} vs ${labels[d.y]}<br>R = <b>${d.value.toFixed(2)}</b>`); })
        .on("mouseout", function() { d3.select("#tooltip").style("opacity", 0); d3.select(this).style("stroke", "none"); });
      svg.append("g").call(d3.axisLeft(y).tickFormat(i => labels[i])).select(".domain").remove();
      svg.append("g").attr("transform", `translate(0,${innerH})`).call(d3.axisBottom(x).tickFormat(i => labels[i])).select(".domain").remove();
    }

    // --- é™„å›¾ 3: æ•£ç‚¹å›¾ (å…³é”®ä¿®å¤ï¼šå½»åº•æ¸…ç©º) ---
    function drawScatterChart(xKey, yKey) {
      if(data.length === 0) return;
      
      const container = document.getElementById('scatter-viz');
      container.innerHTML = ""; // å…³é”®ä¿®å¤ï¼šå½»åº•æ¸…ç©ºå®¹å™¨å†…å®¹

      const width = container.clientWidth; const height = container.clientHeight;
      const margin = { top: 20, right: 20, bottom: 40, left: 50 };
      
      const svg = d3.select("#scatter-viz").append("svg").attr("width", width).attr("height", height).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const innerW = width - margin.left - margin.right; const innerH = height - margin.top - margin.bottom;
      
      const xExtent = d3.extent(data, d => d[xKey]), yExtent = d3.extent(data, d => d[yKey]);
      const xPadding = (xExtent[1] - xExtent[0]) * 0.1 || 1, yPadding = (yExtent[1] - yExtent[0]) * 0.1 || 1;
      
      const x = d3.scaleLinear().domain([xExtent[0] - xPadding, xExtent[1] + xPadding]).range([0, innerW]);
      const y = d3.scaleLinear().domain([yExtent[0] - yPadding, yExtent[1] + yPadding]).range([innerH, 0]);
      
      const xAxis = d3.axisBottom(x).ticks(5);
      if(xKey === 'year') xAxis.tickFormat(d3.format("d"));

      svg.append("g").attr("transform", `translate(0,${innerH})`).call(xAxis);
      svg.append("g").call(d3.axisLeft(y).ticks(5));
      svg.append("text").attr("x", innerW/2).attr("y", innerH+35).style("text-anchor", "middle").style("fill", "#aaa").style("font-size", "12px").text(nameMap[xKey] || xKey);
      svg.append("text").attr("transform", "rotate(-90)").attr("y", -35).attr("x", -innerH/2).style("text-anchor", "middle").style("fill", "#aaa").style("font-size", "12px").text(nameMap[yKey] || yKey);
      
      const colorScale = d3.scaleSequential().domain([40, 100]).interpolator(d3.interpolateTurbo);
      svg.selectAll("circle").data(data).enter().append("circle").attr("class", "dot").attr("cx", d => x(d[xKey])).attr("cy", d => y(d[yKey])).attr("r", 4).style("fill", d => colorScale(d.favorable_rate))
        .on("mouseover", function(event, d) { d3.select(this).attr("r", 7).style("stroke", "#fff").style("stroke-width", 2); 
            const content = `<div class="tooltip-title">${d.name}</div><div class="tooltip-row"><span>${nameMap[xKey]}:</span> <b>${d[xKey]}</b></div><div class="tooltip-row"><span>${nameMap[yKey]}:</span> <b>${d[yKey]}</b></div>`;
            showTooltip(event, content); })
        .on("mouseout", function() { d3.select("#tooltip").style("opacity", 0); d3.select(this).attr("r", 4).style("stroke", "#000").style("stroke-width", 1); });
    }

    // --- åˆå§‹åŒ– ---
    function init() {
      if(data.length > 0){
        drawParallelPlot();
        drawHeatmap();
        drawBarChart(document.getElementById('targetSelect').value);
        drawScatterChart(document.getElementById('scatterX').value, document.getElementById('scatterY').value);
      }
      drawTagBubbleChart();
    }
    init();

    window.addEventListener('resize', () => { clearTimeout(window.resizeTimer); window.resizeTimer = setTimeout(init, 100); });
    document.getElementById('searchName').addEventListener('input', function() { window.updateParallelChart(this.value, document.getElementById('selectYear').value); });
    document.getElementById('selectYear').addEventListener('change', function() { window.updateParallelChart(document.getElementById('searchName').value, this.value); });
    document.getElementById('targetSelect').addEventListener('change', function() { drawBarChart(this.value); });
    function updateScatter() { drawScatterChart(document.getElementById('scatterX').value, document.getElementById('scatterY').value); }
    document.getElementById('scatterX').addEventListener('change', updateScatter);
    document.getElementById('scatterY').addEventListener('change', updateScatter);
    window.resetFilters = function() { document.getElementById('searchName').value = ''; document.getElementById('selectYear').value = ''; window.updateParallelChart("", ""); }
  </script>
</body>
</html>